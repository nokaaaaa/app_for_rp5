<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Unity + ROS WebRTC Stream</title>

  <!-- スマホ横持ち推奨・ズーム禁止 -->
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0,
                 maximum-scale=1.0, user-scalable=no,
                 viewport-fit=cover">

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #000;
      touch-action: none;
    }

    #unity-container {
      width: 100%;
      height: 100%;
      position: relative;
      overflow: hidden;
    }

    #unity-canvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    /* ---- ローディングアニメーション非表示 ---- */
    #unity-loading-bar,
    #unity-logo,
    #unity-progress-bar-empty,
    #unity-progress-bar-full,
    #unity-footer {
      display: none !important;
    }

    /* ★ 映像コンテナ：X 中央・Y=0 基準 */
    #ros-overlay {
      position: absolute;
      top: 0;  
      left: 50%;
      transform: translateX(-50%);
      z-index: 999;
      background: rgba(0, 0, 0, 0.0);
      padding: 0;
    }

    /* ★ 映像：高さ 80%・横はアスペクト比で自動計算 */
    #video-player {
      height: 80vh;           /* 画面の縦の 8 割 */
      aspect-ratio: 4 / 3;    /* 必要なら 16 / 9 などに変更 */
      width: auto;            /* 高さから横幅決定 */
      border-radius: 8px;
      background: black;
      display: block;
    }
  </style>
</head>

<body>
  <div id="unity-container" class="unity-desktop">
    <canvas id="unity-canvas" tabindex="-1"></canvas>

    <div id="ros-overlay">
      <video id="video-player" autoplay playsinline></video>
    </div>
  </div>

  <!-- Unity Load -->
  <script>
    var canvas = document.querySelector("#unity-canvas");

    var buildUrl = "App/Build";
    var loaderUrl = buildUrl + "/App.loader.js";
    var config = {
      dataUrl: buildUrl + "/App.data",
      frameworkUrl: buildUrl + "/App.framework.js",
      codeUrl: buildUrl + "/App.wasm",
      streamingAssetsUrl: "StreamingAssets",
      companyName: "DefaultCompany",
      productName: "AGV_app",
      productVersion: "1.0",
      showBanner: () => {}
    };

    var script = document.createElement("script");
    script.src = loaderUrl;
    script.onload = () => {
      createUnityInstance(canvas, config).catch((message) => alert(message));
    };
    document.body.appendChild(script);
  </script>

  <!-- WebRTC 自動開始 -->
  <script>
    async function startWebRTC() {
      const pc = new RTCPeerConnection();

      pc.ontrack = (event) => {
        const video = document.getElementById("video-player");
        if (!video.srcObject) video.srcObject = new MediaStream();
        video.srcObject.addTrack(event.track);
      };

      pc.addTransceiver('video', { direction: 'recvonly' });

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      try {
        const response = await fetch("http://" + location.hostname + ":8080/offer", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(offer),
        });

        const answer = await response.json();
        await pc.setRemoteDescription(answer);
      } catch (e) {
        console.error(e);
      }
    }
    window.addEventListener("load", startWebRTC);

    /* ダブルタップズーム禁止 */
    let lastTouch = 0;
    document.addEventListener("touchend", (e) => {
      const now = Date.now();
      if (now - lastTouch < 300) e.preventDefault();
      lastTouch = now;
    }, { passive: false });

    /* 横持ち強制（可能な範囲で） */
    screen.orientation?.lock?.("landscape").catch(() => {});
  </script>
</body>
</html>
